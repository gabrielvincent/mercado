package stats

import (
	l "mercado/app/views/layouts"
	stringsUtils "mercado/utils/strings"
	expense "mercado/app/models/expense"
	"time"
	"strconv"
)

func daysInMonth(year, month int) int {
	lastDay := time.Date(year, time.Month(month)+1, 0, 0, 0, 0, 0, time.UTC).Day()
	return lastDay
}

func getCurrentDayOfMonth() int {
	now := time.Now()
	return now.Day()
}

templ Semibold() {
	<span class="font-semibold">
		{ children... }
	</span>
}

templ Currency(value int) {
	@Semibold() {
		{ stringsUtils.FormatCurrency(value) }
	}
}

templ PreviousMonthCompare(info *expense.PreviousMonthCompareInfo) {
	<span>A essa altura, no mÃªs passado, vocÃª tinha gastado</span>
	{ " " }@Currency(info.Total) {
	"."
}
}

templ Sessions(expenses []expense.Expense, info *expense.PreviousMonthCompareInfo, day int) {
	VocÃª jÃ¡ foi ao mercado
	{ " " }@Semibold() {
	{  strconv.Itoa(len(expenses)) }
}
	{ " " }
	vezes esse mÃªs.
	if info != nil {
		{ " " }No mÃªs passado, atÃ© o dia <span class="font-semibold">{ strconv.Itoa(day) }</span>, tinham sido <span class="font-semibold">{ strconv.Itoa(info.Sessions) }</span> idas ao mercado.
	}
}

var isFirst = true

script loadDeferred(id string) {
    loadDeferredComponent(id)
}

templ DeferredComponent(id string, completed bool, children ...any) {
	<div
		data-defer-id={ id }
		data-defer-completed={ strconv.FormatBool(completed) }
	>
		{ children... }
	</div>
	@loadDeferred(id)
}

templ GroceryStoresRanking(ranking []expense.GroceryStoresRankingItem) {
	@DeferredComponent("grocery-stores-ranking", true) {
		O mercado que vocÃª mais visitou foi o
		{ " " }@Semibold() {
	{ ranking[0].GroceryStore }
}
		{ "." }
		VocÃª lÃ¡ esteve
		{ " " }@Semibold() {
	{ strconv.Itoa(ranking[0].Sessions) }
}
		{ " " }vezes. O ranking Ã© esse aqui:
		<div
			class="mt-2 p-3 bg-gray-100 rounded-lg"
		>
			for i, item := range ranking {
				<div class="flex items-center gap-2">
					<span>
						switch i {
							case 0:
								ğŸ¥‡
							case 1:
								ğŸ¥ˆ
							case 2:
								ğŸ¥‰
							case 3:
								4ï¸âƒ£
							case 4:
								5ï¸âƒ£
							case 5:
								6ï¸âƒ£
							case 6:
								7ï¸âƒ£
							case 7:
								8ï¸âƒ£
							case 8:
								9ï¸âƒ£
							case 9:
								ğŸ”Ÿ
							default:
								{ "- " }
						}
					</span>
					<div class="w-full flex items-center justify-between">
						<span
							class={ "font-semibold",
                            templ.KV("text-amber-400", i == 0),
                            templ.KV("text-stone-400", i == 1),
                            templ.KV("text-orange-400", i == 2) }
						>
							{ item.GroceryStore }
						</span>
						<span>
							({ strconv.Itoa(item.Sessions) }
							if item.Sessions > 1 {
								{ " " }visitas)
							} else {
								{ " " }visita)
							}
						</span>
					</div>
				</div>
			}
		</div>
	}
}

templ Index(
	expenses []expense.Expense,
	prevMonthCompareInfo *expense.PreviousMonthCompareInfo,
) {
	@l.Layout() {
		<div class="p-4">
			<button onclick="alert('Click me!')">Click me!</button>
			<h1 class="font-bold text-lg mb-4">OlÃ¡, { ctx.Value("name").(string) },</h1>
			<p>
				hoje Ã© o 
				<span class="font-semibold">{ strconv.Itoa(getCurrentDayOfMonth()) }Âº</span>
				dia do mÃªs e vocÃª jÃ¡ gastou
				<span class="font-semibold">
					@Currency(expense.CalcTotal(expenses))
				</span>.
				AtÃ© agora, vocÃª gastou em mÃ©dia 
				@Currency(int(expense.CalcAvg(expenses)))
				{ " " }a cada ida ao mercado (foram jÃ¡ <span class="font-semibold">{ strconv.Itoa(len(expenses)) }</span>
				if len(expenses) > 1 {
					vezes,
				} else {
					vez,
				}
				uma mÃ©dia de
				<span class="font-semibold">{ strconv.FormatFloat(float64(len(expenses)) / float64(getCurrentDayOfMonth()) , 'f', 2, 64) }</span>
				idas ao mercado por dia, o que dÃ¡ uma mÃ©dia de
				<span class="font-semibold">
					@Currency(int(float64(expense.CalcTotal(expenses)) / float64(getCurrentDayOfMonth())))
				</span> gastos por dia!)
				VocÃª acha bonita uma coisa dessas?
			</p>
			if prevMonthCompareInfo != nil {
				<p class="mt-4">
					@PreviousMonthCompare(prevMonthCompareInfo)
				</p>
			}
			<p class="mt-4">
				@Sessions(expenses, prevMonthCompareInfo, getCurrentDayOfMonth())
			</p>
			<p class="mt-4">
				<div data-defer-id="grocery-stores-ranking">
					O mercado que vocÃª mais visitou foi o ---. VocÃª lÃ¡ esteve --- vezes. O ranking Ã© esse aqui:
					<div class="w-full flex flex-col justify-between gap-2 p-3 bg-gray-100 rounded-lg">
						<div>Loading...</div>
						<div>---</div>
						<div>------</div>
						<div>----</div>
					</div>
				</div>
			</p>
		</div>
	}
}
